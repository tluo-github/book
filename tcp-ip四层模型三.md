# TCP IP 应用层 TCP和UDP 协议

>在TCP IP四层模型(二)中，IP协议已经帮助我们根据IP来找到目标的MAC地址进行通信，这篇就来说说在IP协议至上我们传输层TCP,UDP这2个协议相关

我们在第一篇文章中简单的对TCP,UDP进行了说明定义

* TCP 协议是一个面向连接的、可靠的协议。\(有额外开销\)
* UDP 协议是一个不可靠的、无连接协议。\(无额外开销速度快\)

简单的说就是TCP协议更可靠(下面要讲到三次握手),而我们Web程序用的HTTP协议也是基于TCP协议,所以主要讲讲TCP协议，当然UDP的特征不确保可靠，但是无太多额外开销所以更剩流量和速度更快。不同的应用场景选择不同

###TCP头格式
>我们在上面看过IP协议的头格式,这里我们就直接看看TCP的头格式

![](/assets/QQ截图20161017105911.jpg)
(中文版)
![](http://coolshell.cn//wp-content/uploads/2014/05/TCP-Header-01.jpg)
(英文版)

> * 做程序这行有时候英文还是方便，所以这里我们尽量看英文版,可以对照中文看
> * 1 比特 符号为 1bit
> * 1 字节 符号为 1byte
> * 1字节=8比特 即 1byte = 8bit
> * 跟IP协议一样每行32bits(等于4bytes)固定部分有5行共160bits(等于20bytes)


* Source Port（来源端口），长度16bits。发送链接端口，范围0~65525
* Destination Port（目标端口）,长度16bits。接受链接端口，范围0~65525
* Sequence Number（序列号码SYN），长度32bits。数据序列号码，TCP 连接中传送的数据流中的每一个字节都编上一个序号。如果没有同步化旗标（SYN），则此为第一个数据比特的序列码。
  如果含有同步化旗标（SYN），则此为最初的序列号；第一个数据比特的序列码为本序列号加一。
* Acknowledgment Number(确认号码ACK),长度32bit,期望收到对方的下一个报文段的数据的第一个字节的序号,也即已经收到的数据的字节长度加1。
* Offset（偏移），长度4bits,单位为字节，它指出报文数据距TCP报头的起始处有多远(TCP报文头长度)。
* Reserved（保留字段）,长度6bits,保留今后使用，目前设置为0
* TCP Flags（标识符）

> * URG—紧急比特，1bit，当 URG=1 时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)
> * ACK—确认比特，1bit，只有当 ACK=1时确认号字段才有效。当 ACK=0 时，确认号无效
> * PSH—推送比特，1bit，接收方 TCP 收到推送比特置1的报文段，就尽快地交付给接收应用进程，而不再等到整个缓存都填满了后再向上交付
> * RST—复位比特，1bit，当RST=1时，表明TCP连接中出现严重差错(如由于主机崩溃或其他原因)，必须释放连接，然后再重新建立运输连接
> * SYN—同步比特，1bit，同步比特 SYN 置为 1，就表示这是一个连接请求或连接接受报文
> * FIN—终止比特，1bit，用来释放一个连接。当FIN=1 时，表明此报文段的发送端的数据已发送完毕，并要求释放运输连接

* Window(窗体大小，ps:不是微软操作系统),长度16bits，窗口字段用来控制对方发送的数据量，单位为字节。TCP 连接的一端根据设置的缓存空间大小确定自己的接收窗口大小，然后通知对方以确定对方的发送窗口的上限。用于流量控制。(计划在以后写带宽时详细解释)
* Checksum(校验和),长度16bits,对整个的TCP报文段，包括TCP头部和TCP数据，以16位字进行计算所得。这是一个强制性的字段。
* Urgent Pointer（紧急指针）,长度16bits,紧急指针指出在本报文段中的紧急数据的最后一个字节的序号。
* Options（选项字段），长度可变。TCP首部可以有多达40字节的可选信息，用于把附加信息传递给终点，或用来对齐其它选项。 这部分最多包含40字节，因为TCP头部最长是60字节（其中还包含前面讨论的20字节的固定部分）

> * 第一个字段kind-选项类型
> * 第二个字段length(如果有的话)指定该选项的总长度，该长度包括kind字段和length字段占据的2字节。
> * 第三个字段info（如果有的话）是选项的具体信息.
> * 1. kind=0是选项表结束选项
> * 2. kind=1是空操作（nop）选项，没有特殊含义，一般用于将TCP选项的总长度填充为4字节的整数倍
> * 3. kind=2是最大报文段长度选项,TCP连接初始化时，通信双方使用该选项来协商最大报文段长度（Max Segment Size，MSS）。TCP模块通常将MSS设置为（MTU-40）字节（减掉的这40字节包括20字节的TCP头部和20字节的IP头部）。这样携带TCP报文段的IP数据报的长度就不会超过MTU（假设TCP头部和IP头部都不包含选项字段，并且这也是一般情况），从而避免本机发生IP分片。对以太网而言，MSS值是1460（1500-40）字节。




